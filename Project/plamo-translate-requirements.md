# 機能要件定義書：PLaMo Translate Chrome拡張機能

## ドキュメント情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | PLaMo Translate Chrome Extension |
| バージョン | 1.0.0 (MVP) |
| 作成日 | 2025-10-01 |
| 最終更新日 | 2025-10-01 |
| 作成者 | Sora |
| ステータス | Draft |

---

## 1. プロジェクト概要

### 1.1 目的

ローカルで動作するPLaMo TranslateモデルをLM Studio経由で使用し、Chrome拡張機能としてWebページ上のテキストを日英間で翻訳する。

### 1.2 スコープ

**対象範囲 (In-Scope)**:
- Chrome拡張機能の開発（Manifest V3）
- LM Studio APIとの統合
- 日英・英日の双方向翻訳
- コンテキストメニュー（右クリック）からの翻訳
- 基本的なUI（ポップアップ、インライン表示）

**対象外 (Out-of-Scope)**:
- PLaMo Translateモデルのトレーニング・カスタマイズ
- LM Studioのインストール・セットアップ
- 日英以外の言語ペア（将来拡張として検討）
- リアルタイム全文翻訳
- オフライン辞書機能
- ブラウザ拡張以外のプラットフォーム対応

### 1.3 前提条件

- ユーザーがLM Studioをインストール済み
- PLaMo Translate (GGUF版) がダウンロード済み
- LM Studioサーバーが `localhost` または `127.0.0.1` の任意ポートで起動中
- Google Chrome 88以降がインストール済み

---

## 2. ユーザーストーリー

### US-001: テキスト選択翻訳

**As a** Webページの閲覧者  
**I want to** 選択したテキストを右クリックで翻訳したい  
**So that** 外国語のコンテンツを素早く理解できる

**受け入れ基準**:
- テキストを選択できること
- 右クリックメニューに「PLaMoで翻訳」が表示されること
- クリックすると翻訳が実行されること
- 翻訳結果が3秒以内に表示されること

---

### US-002: 自動言語検出

**As a** ユーザー  
**I want to** 翻訳方向を手動で指定せずに翻訳したい  
**So that** 操作の手間を省ける

**受け入れ基準**:
- 日本語テキストは自動的に英語に翻訳されること
- 英語テキストは自動的に日本語に翻訳されること
- 言語検出が95%以上の精度であること

---

### US-003: 翻訳結果の表示

**As a** ユーザー  
**I want to** 翻訳結果を読みやすい形式で見たい  
**So that** 翻訳内容を快適に確認できる

**受け入れ基準**:
- ポップアップまたはツールチップで結果が表示されること
- フォントサイズが読みやすいこと（最低14px）
- 背景色とテキスト色のコントラストが十分であること
- 閉じるボタンまたはESCキーで閉じられること

---

### US-004: 設定のカスタマイズ

**As a** ユーザー  
**I want to** LM StudioのURLを変更できるようにしたい  
**So that** 異なるポートやリモートサーバーに対応できる

**受け入れ基準**:
- 拡張機能のポップアップから設定画面にアクセスできること
- サーバーURLを入力・保存できること
- 設定が永続化されること（ブラウザ再起動後も保持）

---

### US-005: エラーハンドリング

**As a** ユーザー  
**I want to** エラーが発生した際に分かりやすいメッセージを見たい  
**So that** 問題を自分で解決できる

**受け入れ基準**:
- LM Studio未起動時に「サーバーに接続できません」と表示されること
- タイムアウト時に「リクエストがタイムアウトしました」と表示されること
- エラーメッセージが日本語で表示されること

---

## 3. 機能要件

### 3.1 必須機能 (Must Have) - MVP

#### F-001: コンテキストメニュー統合

**説明**: Webページ上でテキスト選択時に右クリックメニューに翻訳オプションを追加

**詳細**:
- メニュー項目名: 「PLaMoで翻訳」
- アイコン: 拡張機能のロゴ（16x16px）
- 表示条件: テキストが選択されている場合のみ

**技術仕様**:
```javascript
chrome.contextMenus.create({
  id: 'translate-with-plamo',
  title: 'PLaMoで翻訳',
  contexts: ['selection']
});
```

**優先度**: P0 (最高)

---

#### F-002: 言語自動検出

**説明**: 選択されたテキストの言語を自動判定し、適切な翻訳方向を決定

**ロジック**:
- 日本語文字（ひらがな、カタカナ、漢字）が含まれる → 日本語と判定
- 上記以外 → 英語と判定

**技術仕様**:
```javascript
function detectLanguage(text) {
  const japaneseRegex = /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/;
  return japaneseRegex.test(text) ? 'Japanese' : 'English';
}
```

**制約**:
- 混在テキスト（日英混合）は主要言語で判定
- 第三言語（中国語、韓国語等）は英語として扱う

**優先度**: P0 (最高)

---

#### F-003: LM Studio API連携

**説明**: LM Studioのローカルサーバー経由でPLaMo Translateモデルに翻訳リクエストを送信

**エンドポイント**: `POST http://localhost:1234/v1/chat/completions`

**リクエスト形式**:
```json
{
  "model": "mmnga/plamo-2-translate-gguf",
  "messages": [
    {
      "role": "user",
      "content": "<|plamo:op|>dataset\ntranslation\n\n<|plamo:op|>input lang=English\nHello, world!\n<|plamo:op|>output lang=Japanese"
    }
  ],
  "max_tokens": 1000,
  "temperature": 0,
  "stop": ["<|plamo:op|>"]
}
```

**エラーハンドリング**:
- 接続エラー（ECONNREFUSED）: 「LM Studioが起動していません」
- タイムアウト（30秒）: 「リクエストがタイムアウトしました」
- HTTP 500: 「モデルエラーが発生しました」

**優先度**: P0 (最高)

---

#### F-004: 翻訳結果の表示

**説明**: 翻訳結果をポップアップまたはインライン要素で表示

**UI仕様**:
- **表示位置**: 選択テキストの近傍（マウスカーソル位置から50px下）
- **サイズ**: 最大幅400px、高さ自動調整
- **スタイル**:
  - 背景色: `#ffffff`
  - テキスト色: `#333333`
  - フォント: システムデフォルト、14px
  - パディング: 16px
  - ボーダー: 1px solid #cccccc
  - シャドウ: `0 2px 8px rgba(0,0,0,0.15)`

**インタラクション**:
- 外側クリックで閉じる
- ESCキーで閉じる
- 翻訳結果をクリックでコピー（オプション）

**優先度**: P0 (最高)

---

#### F-005: 設定画面

**説明**: 拡張機能の動作を設定するポップアップUI

**設定項目**:
1. **LM Studio URL**
   - デフォルト: `http://localhost:1234`
   - 検証: URL形式チェック
2. **モデル名**
   - デフォルト: `mmnga/plamo-2-translate-gguf`
   - リスト選択（利用可能モデルを取得）
3. **最大トークン数**
   - デフォルト: `1000`
   - 範囲: 100 - 4096

**UI構成**:
```
┌──────────────────────────────┐
│  PLaMo Translate 設定        │
├──────────────────────────────┤
│  LM Studio URL:              │
│  [http://localhost:1234    ] │
│                              │
│  モデル:                     │
│  [mmnga/plamo-2-translate  ▼]│
│                              │
│  最大トークン数:             │
│  [1000                     ] │
│                              │
│  [接続テスト]  [保存]        │
└──────────────────────────────┘
```

**優先度**: P0 (最高)

---

### 3.2 推奨機能 (Should Have)

#### F-006: 翻訳履歴

**説明**: 過去の翻訳結果を保存し、履歴から再確認可能にする

**仕様**:
- 最大保存数: 50件
- 保存内容: 元テキスト、翻訳結果、タイムスタンプ
- UI: ポップアップの「履歴」タブから閲覧

**優先度**: P1

---

#### F-007: キーボードショートカット

**説明**: キーボードショートカットで翻訳を実行

**デフォルト**: `Ctrl+Shift+T` (Windows/Linux), `Cmd+Shift+T` (macOS)

**動作**:
- テキスト選択状態でショートカット実行
- コンテキストメニューと同じ翻訳処理を実行

**優先度**: P1

---

#### F-008: ダークモード対応

**説明**: ブラウザのテーマに応じてUIを切り替え

**仕様**:
- `prefers-color-scheme: dark` メディアクエリで検出
- ダークモード時の配色:
  - 背景色: `#2d2d2d`
  - テキスト色: `#e0e0e0`
  - ボーダー: `#555555`

**優先度**: P2

---

### 3.3 オプション機能 (Nice to Have)

#### F-009: 複数選択翻訳

**説明**: 複数の選択範囲を一度に翻訳

**優先度**: P3

---

#### F-010: カスタムプロンプト

**説明**: ユーザーが翻訳プロンプトをカスタマイズ可能

**優先度**: P3

---

## 4. 非機能要件

### 4.1 パフォーマンス

| 項目 | 要件 |
|------|------|
| **翻訳レスポンス時間** | 通常時: 3秒以内、最大: 10秒 |
| **メモリ使用量** | Chrome拡張: 最大50MB |
| **起動時間** | 拡張機能のロード: 1秒以内 |

### 4.2 ユーザビリティ

| 項目 | 要件 |
|------|------|
| **言語** | UI: 日本語、エラーメッセージ: 日本語 |
| **アクセシビリティ** | WCAG 2.1 Level AA準拠 |
| **学習コスト** | 初回使用時の説明なしで操作可能 |

### 4.3 セキュリティ

| 項目 | 要件 |
|------|------|
| **データ送信** | 翻訳データは localhost のみに送信 |
| **XSS対策** | `textContent` 使用、`innerHTML` 禁止 |
| **CSP** | `script-src 'self'` を設定 |

### 4.4 互換性

| 項目 | 要件 |
|------|------|
| **ブラウザ** | Chrome 88+, Edge 88+ (Chromium版) |
| **OS** | Windows 10+, macOS 10.15+, Linux (Pop!_OS 22.04+) |
| **LM Studio** | バージョン 0.2.19以降 |

### 4.5 保守性

| 項目 | 要件 |
|------|------|
| **コード規約** | ESLint + Prettier |
| **コメント** | 全関数にJSDoc形式のコメント |
| **バージョン管理** | Git, セマンティックバージョニング |

---

## 5. データモデル

### 5.1 翻訳リクエスト

```typescript
interface TranslationRequest {
  text: string;           // 翻訳対象テキスト
  sourceLang: 'English' | 'Japanese';
  targetLang: 'English' | 'Japanese';
  timestamp: number;      // Unix timestamp
}
```

### 5.2 翻訳レスポンス

```typescript
interface TranslationResponse {
  success: boolean;
  translation?: string;   // 翻訳結果
  error?: string;         // エラーメッセージ
  processingTime?: number; // 処理時間（ms）
}
```

### 5.3 設定データ

```typescript
interface Settings {
  lmStudioUrl: string;    // デフォルト: "http://localhost:1234"
  modelName: string;      // デフォルト: "mmnga/plamo-2-translate-gguf"
  maxTokens: number;      // デフォルト: 1000
  temperature: number;    // デフォルト: 0
}
```

### 5.4 翻訳履歴

```typescript
interface TranslationHistory {
  id: string;             // UUID
  originalText: string;
  translatedText: string;
  sourceLang: string;
  targetLang: string;
  timestamp: number;
  url: string;            // 翻訳元のURL
}
```

---

## 6. UIワイヤーフレーム

### 6.1 コンテキストメニュー

```
┌────────────────────────┐
│ コピー                 │
│ 貼り付け               │
│ ────────────────────   │
│ 🔄 PLaMoで翻訳         │ ← 追加
│ ────────────────────   │
│ 検索...                │
└────────────────────────┘
```

### 6.2 翻訳結果ポップアップ

```
┌─────────────────────────────────┐
│ PLaMo Translate                 │
├─────────────────────────────────┤
│ 元のテキスト:                   │
│ "Hello, world!"                 │
│                                 │
│ 翻訳結果:                       │
│ 「こんにちは、世界！」          │
│                                 │
│ 処理時間: 2.3秒                 │
│                                 │
│          [コピー]  [閉じる]     │
└─────────────────────────────────┘
```

### 6.3 設定ポップアップ

```
┌──────────────────────────────────┐
│ ⚙️  設定         [翻訳] [履歴]   │
├──────────────────────────────────┤
│                                  │
│ LM Studio URL                    │
│ ┌──────────────────────────────┐ │
│ │ http://localhost:1234        │ │
│ └──────────────────────────────┘ │
│                                  │
│ モデル                           │
│ ┌──────────────────────────────┐ │
│ │ mmnga/plamo-2-translate-gguf▼│ │
│ └──────────────────────────────┘ │
│                                  │
│ 最大トークン数                   │
│ ┌──────────────────────────────┐ │
│ │ 1000                         │ │
│ └──────────────────────────────┘ │
│                                  │
│  [接続テスト]        [保存]      │
│                                  │
│ ステータス: ✅ 接続成功           │
└──────────────────────────────────┘
```

---

## 7. テストケース

### 7.1 機能テスト

| ID | テストケース | 期待結果 |
|----|--------------|----------|
| TC-001 | 英語テキスト「Hello」を選択して翻訳 | 「こんにちは」と表示 |
| TC-002 | 日本語テキスト「こんにちは」を選択して翻訳 | "Hello" と表示 |
| TC-003 | 長文（500文字）を翻訳 | 10秒以内に結果表示 |
| TC-004 | LM Studio未起動時に翻訳 | エラーメッセージ表示 |
| TC-005 | 設定でURLを変更して保存 | 再起動後も設定が保持される |

### 7.2 互換性テスト

| ID | テストケース | 期待結果 |
|----|--------------|----------|
| TC-101 | Chrome 88で動作確認 | 正常動作 |
| TC-102 | Windows 10で動作確認 | 正常動作 |
| TC-103 | Pop!_OS 22.04で動作確認 | 正常動作 |

### 7.3 パフォーマンステスト

| ID | テストケース | 期待結果 |
|----|--------------|----------|
| TC-201 | 短文（50文字）の翻訳時間測定 | 3秒以内 |
| TC-202 | 長文（500文字）の翻訳時間測定 | 10秒以内 |
| TC-203 | 連続10回翻訳のメモリリーク確認 | メモリ使用量が50MB以下 |

---

## 8. リリース計画

### 8.1 マイルストーン

| マイルストーン | 期日 | 主要機能 |
|----------------|------|----------|
| **M1: MVP** | Week 2 | F-001～F-005（必須機能） |
| **M2: 改善版** | Week 4 | F-006～F-008（推奨機能） |
| **M3: 完全版** | Week 6 | F-009～F-010（オプション機能） |

### 8.2 受け入れ基準

**MVP (M1) のリリース条件**:
- 全必須機能（F-001～F-005）が実装済み
- 全機能テスト（TC-001～TC-005）が合格
- README、ドメイン知識、機能要件のドキュメントが完成
- LM Studio + PLaMo Translateの動作が確認済み

---

## 9. リスクと制約

### 9.1 技術的リスク

| リスク | 影響度 | 対策 |
|--------|--------|------|
| LM Studioのバージョン変更によるAPI互換性問題 | 高 | バージョン固定、互換性テスト |
| PLaMo Translateモデルの更新 | 中 | 複数バージョン対応 |
| ブラウザのManifest V3仕様変更 | 中 | Chrome公式ドキュメント追跡 |

### 9.2 制約事項

| 制約 | 説明 |
|------|------|
| **オフライン動作不可** | LM Studioサーバーが必須 |
| **リソース消費** | PLaMo Translateモデルは5GB以上のディスク容量が必要 |
| **言語ペア制限** | MVP版は日英のみ対応 |
| **推論速度** | ハードウェア性能に依存（CPU/GPUの有無） |

---

## 10. 付録

### 10.1 用語集

| 用語 | 説明 |
|------|------|
| **PLaMo** | Preferred Networks製の大規模言語モデル |
| **GGUF** | llama.cpp用の効率的なモデル形式 |
| **量子化** | モデルの重みを低精度化してサイズ削減 |
| **Manifest V3** | Chromeの最新拡張機能プラットフォーム |
| **Service Worker** | イベント駆動のバックグラウンドスクリプト |

### 10.2 参考資料

1. [Chrome Extension開発ガイド](https://developer.chrome.com/docs/extensions/)
2. [LM Studio APIドキュメント](https://lmstudio.ai/docs/local-server)
3. [PLaMo公式サイト](https://www.preferred.jp/)
4. [llama.cpp GitHub](https://github.com/ggml-org/llama.cpp)

---

**承認者**: -  
**承認日**: -  
**バージョン**: 1.0.0  
**ステータス**: Draft → Review → Approved
